<?php
// $Id$

/**
 * @file
 * Notifies users about new Private Messages via Email.
 */

/**
 * Implementation of hook_menu().
 */
function pm_email_notify_menu() {
  $items['admin/config/messaging/privatemsg/notify'] = array(
    'title'            => 'E-mail notify',
    'description'      => 'E-mail notification settings',
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('pm_email_notify_admin_settings_form'),
    'file'             => 'pm_email_notify.admin.inc',
    'access arguments' => array('administer privatemsg settings'),
    'type'             => MENU_LOCAL_TASK,
    'weight'           => 10,
  );
  return $items;
}

/**
 * Retrieve notification setting of a user.
 *
 * This function retrieves user's pm notification preference from database,
 * if user preference doesn't exist - it uses default value instead
 *
 * @param $uid
 *   User uid
 */
function _pm_email_notify_is_enabled($uid) {
  $notifications = &drupal_static(__FUNCTION__, array());
  // Cache the result set in case this method is executed in batched operation which will perform many unnecessary repeated selects for the same user
  if (!isset($notifications[$uid]) ) {
    $mail_notification = db_query('SELECT email_notify_is_enabled FROM {pm_email_notify} WHERE user_id = :uid', array(':uid' => $uid))->fetchField();
    if ($mail_notification === FALSE) { //db_result returns FALSE if result was not found.
      $mail_notification = variable_get('pm_email_notify_default', TRUE);
    }
    $notifications[$uid] = $mail_notification;
  }
  return $notifications[$uid];
}

/**
 * Implementation of hook_privatemsg_message_insert().
 */
function pm_email_notify_privatemsg_message_insert($message) {
  foreach ($message->recipients as $recipient) {
    // check if recipient enabled email notifications
    if (isset($recipient->uid) && _pm_email_notify_is_enabled($recipient->uid)) {
      // send them a new pm notification email if they did
      $params['recipient'] = $recipient;
      $params['message'] = $message;
      drupal_mail('pm_email_notify', 'notice', $recipient->mail, user_preferred_language($recipient), $params);
    }
  }
}

/**
 * Implementation of hook_mail().
 */
function pm_email_notify_mail($key, &$message, $params) {
  $language = $message['language'];
  $variables = _pm_email_notify_token($params['recipient'], $params['message']);
  switch ($key) {
    case 'notice':
      $message['subject'] = trim(t(variable_get('pm_email_notify_subject', 'New private message at !site.'), $variables, array('langcode' => $language->language)));
      $message['body'] = array(trim(t(variable_get('pm_email_notify_body', _pm_email_notify_default_body()), $variables, array('langcode' => $language->language))));
      break;
  }
}

/**
 * Return an array of token to value mappings for user e-mail messages.
 *
 * @param $message
 *  The private message array being sent.  Must contain at
 *  least the fields 'author', 'subject', 'thread_id' and 'body'.
 * @return
 *  Array of mappings from token names to values (for use with strtr()).
 */
function _pm_email_notify_token($recipient, $message) {

  $tokens = array(
    '!author' => $message->author->name,
    '!thread' => $message->thread_id,
    '!pm_subject' => drupal_html_to_text(check_plain($message->subject)),
    '!pm_body' => drupal_html_to_text(check_markup($message->body, $message->format)),
    '!user_uid' => $recipient->uid,
    '!message' => url('messages/view/' . $message->thread_id, array('absolute' => TRUE)),
    '!settings' => url('user/' . $recipient->uid . '/edit', array('absolute' => TRUE)),
  );

  return $tokens;

}

/**
 * Returns default email notification body.
 */
function _pm_email_notify_default_body() {
  return "Hi !username,\n\nThis is an automatic reminder from the site !site. You have received a new private message from !author.\n\nTo read your message, follow this link:\n!message\n\nIf you don't want to receive these emails again, change your preferences here:\n!settings";
}

/**
 * Implements hook_form_alter().
 */
function pm_email_notify_form_alter(&$form, &$form_state, $form_id) {
  // We have to use user_acces() because privatemsg_user_access() would
  // return FALSE when privatemsg is disabled.
  if (($form_id == 'user_register_form' || $form_id == 'user_profile_form') && $form['#user_category'] == 'account' && privatemsg_user_access('read privatemsg')) {
    $form['enable_pm_mail'] = array(
      '#type' => 'fieldset',
      '#title' => t('Privatemsg e-mail notification'),
      '#collapsible' => TRUE,
      '#collapsed' => FALSE,
      '#weight' => 10,
    );
    $form['enable_pm_mail']['pm_send_notifications'] = array(
      '#type' => 'checkbox',
      '#title' => t('Receive email notification for incoming private messages'),
      '#default_value' => _pm_email_notify_is_enabled($form['#user']->uid),
    );
  }
}

/**
 * Implements hook_user_update().
 */
function pm_email_notify_user_update(&$edit, $account, $category) {
  if ($category == 'account' && privatemsg_user_access('read privatemsg')) {
    db_merge('pm_email_notify')
      ->fields(array('email_notify_is_enabled' => $edit['pm_send_notifications']))
      ->key(array('user_id' => $account->uid))
      ->execute();
  }
}
