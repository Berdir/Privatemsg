<?php
function privatemsg_link($type) {
  if ($type == "menu.view" && user_access("access private messages")) {
    $links[] = "<a href=\"module.php?mod=privatemsg\">". t("view inbox") ."</a> (". _privatemsg_get_new_messages() .")";
  }
  
  if ($type == "menu.settings" && user_access("access private messages")) {
    $links[] = "<a href=\"module.php?mod=privatemsg\">". t("private messages") ."</a>";
  }

  return $links ? $links : array();
}

function privatemsg_user($type, $ahem, &$user) {
  if (user_access("access private messages")) {
	  if ($type == "view_public") {
      $output .= form_item("Private message", "<a href=\"module.php?mod=privatemsg&page=formnew&uid=$user->uid\">send private message</a>");
	  }
	  
	  return $output;
	}
}

function privatemsg_block() {
  if (user_access("access private messages")) {
    if ($new_msg = _privatemsg_get_new_messages()) {
      if ($new_msg == 1) {
        $content = '<b>'.t("You have 1 new message").'</b>';
      } else {
        $content = '<b>'.strtr(t("You have %a new messages"), array("%a" => $new_msg)).'</b>';
      }
    } else {
      $content = t("Read your private messages");
    }
    $content = "<div align=\"center\"><a href=\"module.php?mod=privatemsg\">$content</a><br /><br /><a href='module.php?mod=privatemsg&page=formnew'>".t("Write a new message")."</a></div>";
  } else {
    $content = t("Login to read your private messages");
  }
  $blocks[0][subject] = t("Private messages");
  $blocks[0][content] = $content;
  $blocks[0][info] = t("Private messages");
  $blocks[0][link] = "index.php";
  
  return $blocks;
}


function privatemsg_conf_options() {
  $rate = array(5 => format_interval(5), 10 => format_interval(10), 15 => format_interval(15), 20 => format_interval(20), 30 => format_interval(30), 60 => format_interval(60)); 
  $output .= form_select("Private messaging max rate", "privatemsg_max_rate", variable_get("privatemsg_max_rate", 15), $rate, "Max submit rate for private messaging. To prevent abuse.");
  $output .= form_select("Sent message status", "privatemsg_sent_status", variable_get("privatemsg_sent_status", 1), array("Disabled", "Enabled"), "If enabled users can see whether a message has been read or not.");
  $output .= form_select("Delete unread message", "privatemsg_del_unread", variable_get("privatemsg_del_unread", 1), array("Disabled", "Enabled"), "If enabled a sender can delete a message not yet read by recipient. Sent message status must be enabled.");
  $number = array(5 => 5, 10 => 10, 15 => 15, 20 => 20, 25 => 25, 30 => 30, 35 => 35, 40 => 40, 50 => 50, 60 => 60, 80 => 80, 100 => 100);
  $output .= form_select("Messages per page", "privatemsg_per_page", variable_get("privatemsg_per_page", 10), $number, "The maximum number of messages displayed per page; links to browse messages automatically appear.");
  
  return $output;
}


function privatemsg_page() {
  global $page, $theme;
  
  if (user_access("access private messages")) {
    $page = $page ? $page : "list";
    $f = "_privatemsg_page_" . $page;
    if (function_exists($f)) {
      $f();
    }
  } else {
    $theme->header();
    $theme->box(t("Access denied"), message_access());
    $theme->footer();
  }
}


function privatemsg_perm() {
  return array("access private messages");
}


function privatemsg_get_link($name) {
  return "module.php?mod=privatemsg&page=formnewtouser&edit[recipient]=$name";
}

/*
** page functions (a la chatbox.module)
*/

function _privatemsg_page_list($premessage='') {
  global $theme, $msg_to_del, $in_offset, $out_offset;
  
  $rows = variable_get("privatemsg_per_page", 10);
  
  if (!$out_offset) { $out_offset = 0; }
  if (!$in_offset) { $in_offset = 0; }
  
  if ($msg_to_del) {
    foreach ($msg_to_del as $message_id) {
      _privatemsg_message_delete($message_id);
    }
    $premessage = "Messages deleted";
  }
  
  $output = "<br /><p align='center'><b><i>$premessage</i></b></p>";
  $output .= "<form method=\"post\" name=\"messages\" action=\"module.php?mod=privatemsg\">
                <table width=\"100%\" border=\"0\">";
  $output .= _privatemsg_folder_label(t("inbox"));
  $result = _privatemsg_messages_inbox($in_offset, $rows);
  $output .= $result["output"];
  
  $output .= "<tr><td colspan=\"3\" align=\"left\">";
  if ($in_offset > 0) {
    $output .= "<a href=\"module.php?mod=privatemsg&in_offset=".($in_offset-$rows)."&out_offset=$out_offset\">".t("Previous inbox messages")."</a> ";
  }
  $output .= "</td><td colspan=\"2\" align=\"right\">";
  if ($result["num_rows"] >= $rows) {
    $output .= "<a href=\"module.php?mod=privatemsg&in_offset=".($in_offset+$rows)."&out_offset=$out_offset\">".t("Next inbox messages")."</a>";
  }
  $output .= "</td></tr>";
  
  $output .= _privatemsg_folder_label(t("outbox"));
  $result = _privatemsg_messages_sent($out_offset, $rows);
  $output .= $result["output"];
  
  $output .= "<tr><td colspan=\"3\" align=\"left\">";
  if ($out_offset > 0) {
    $output .= "<a href=\"module.php?mod=privatemsg&in_offset=$in_offset&out_offset=".($out_offset-$rows)."\">".t("Previous sent messages")."</a> ";
  }
  $output .= "</td><td colspan=\"2\" align=\"right\">";
  if ($result["num_rows"] >= $rows) {
    $output .= "<a href=\"module.php?mod=privatemsg&in_offset$=in_offset&out_offset=".($out_offset+$rows)."\">".t("Next sent messages")."</a>";
  }
  $output .= "</td></tr>";  
  
  $output .= "</table></form>";
  $output .= "<p align='center'><a href='module.php?mod=privatemsg&page=formnew'>".t("Write a new message")."</a> - <a href='javascript:messages.submit()'  onClick='return confirm(\"".t("Are you sure to delete these messages?")."\")'>".t("Delete messages")."</a></p>";

  $theme->header();
  $theme->box(t("Private Messages"), $output);
  $theme->footer();
}


function _privatemsg_page_formnew($premessage='', $edit='') {
  global $theme, $uid;
  
  if (!$edit["recipient"] && $uid) {
    $account = user_load(array("uid" => $uid));
    $edit["recipient"] = $account->name;
  }
  
  $form .= form_textfield("To", "recipient", $edit[recipient], 50, 64);
  $form .= form_textfield("Subject", "subject", $edit[subject], 50, 64);
  $form .= form_textarea("Message", "message", $edit[message], 80, 5);
  $form .= form_submit(t("Send private message"));  
  
  $theme->header();
  $theme->box(t("Write a new message"), "<br /><p align='center'><b><i>$premessage</i></b></p>".form($form, "post", "module.php?mod=privatemsg&page=send"));
  $theme->footer();
}


function _privatemsg_page_formnewtouser() {
  global $edit;
  _privatemsg_page_formnew('', $edit);
}

function _privatemsg_page_send() {
  global $user, $edit;
  $recipient = _privatemsg_get_uid($edit["recipient"]);
  
  throttle("private message", variable_get(privatemsg_max_rate, 15));
  
  if (!$edit["recipient"] || !$edit["subject"] || !$edit["message"]) {
    _privatemsg_page_formnew(t("Warning: every field required"), $edit);
  } elseif ($recipient == $user->uid) {
    _privatemsg_page_formnew(t("A message to yourself?"), $edit);
  } else {
    if ($recipient) {
      $edit['subject'] = check_input($edit['subject']);
      $edit['message'] = check_input($edit['message'], variable_get("allowed_html", ""));
    
      $sql = "
        INSERT INTO privatemsg
        (author, recipient, subject, message, timestamp, new, hostname)
        VALUES (".$user->uid.", ".$recipient.", '".check_input($edit['subject'])."', '".check_input($edit['message'])."', ".time().", 1, '". getenv("REMOTE_ADDR") ."')
      ";
      $result = db_query($sql);
      _privatemsg_page_list(t("Message sent"));
    } else {
      _privatemsg_page_formnew(t("Warning: user does not exist"), $edit);
    }
  }
}


function _privatemsg_page_view() {
  global $theme, $user, $message_id;
  
  $sql = "
    SELECT privatemsg.id, name, author, privatemsg.timestamp, subject, message, new, recipient
    FROM privatemsg, users
    WHERE ( recipient = ".$user->uid." OR author = ".$user->uid." )
    AND author = users.uid
    AND privatemsg.id = ".check_input($message_id);
    
  $result = db_query($sql);
  $message = db_fetch_object($result);
  if ($message) {
    if (($message->new) && ($user->uid != $message->author)) {
      $sql = "
        UPDATE privatemsg
        SET new = 0
        WHERE recipient = ".$user->uid."
        AND id = ".check_input($message_id);
      $result = db_query($sql);
    }
    
    $body = "
      <p><b>".t("From").":</b> ".check_output($message->name)."<br />
      <b>".t("Subject").":</b> ".check_output($message->subject)."<br />
      <b>".t("Date").":</b> ".format_date($message->timestamp)."</p>
      ".check_output($message->message, 1)."
      <p align='center'>";
    if ($message->recipient == $user->uid) {
      $body .= "<a href='module.php?mod=privatemsg&page=reply&message_id=$message->id'>".t("Reply to this message")."</a> - ";
    }
    if (($message->recipient == $user->uid) || ((variable_get("privatemsg_sent_status", 1) && variable_get("privatemsg_del_unread", 1)) && ($message->new == 1))) {
      $body .= "<a href='module.php?mod=privatemsg&page=delete&message_id=$message->id' onClick='return confirm(\"".t("Are you sure to delete this message?")."\")'>".t("Delete this message")."</a> - ";
    }
      
    $body .= "<a href='module.php?mod=privatemsg'>".t("List messages")."</a></p>";
  } else {
    $body = t("Error: you can't read this message");
  }
  
  $theme->header();
  $theme->box(t("Read message"), $body);
  $theme->footer();
}


function _privatemsg_page_reply() {
  global $user, $message_id;
  
  $sql = "
    SELECT name, subject, message  FROM privatemsg, users
    WHERE recipient = ".$user->uid." 
    AND author = users.uid
    AND privatemsg.id = ".check_input($message_id);
    
  $result = db_query($sql);
  $message = db_fetch_object($result);
  if ($message) {    
    $reply_data["recipient"] = $message->name;
    
    // add "re:" only if not already there
    if (strpos ($message->subject, "re:") === false)
      $reply_data["subject"] = "re: ".$message->subject;
    else
      $reply_data["subject"] = $message->subject;
    
    // body quoting
    $reply_data["message"] = "\n".str_replace ("\n", "\n> ", check_output("\n".$message->message, 0));
    _privatemsg_page_formnew('', $reply_data);
  } else {
    _privatemsg_page_list(t("Error: you can't reply to this message"));
  }
}


function _privatemsg_page_delete() {
  global $message_id;
  
  if (_privatemsg_message_delete($message_id)) {
    _privatemsg_page_list(t("Message deleted"));
  } else {
    _privatemsg_page_list(t("Error: you can't delete this message"));
  }
}


/*
** helper functions
*/

function _privatemsg_get_uid($recipient) {
  $result = db_query("SELECT uid FROM users WHERE name = '".check_input($recipient)."'");
  return db_result($result);
}


function _privatemsg_messages_inbox($offset=0, $rows=10) {
  global $user;
  
  if ($user->uid) {
    $result = db_query("
      SELECT privatemsg.id, users.uid, name, privatemsg.timestamp, subject, new
      FROM privatemsg, users
      WHERE recipient = ".$user->uid." 
      AND author = users.uid
      ORDER BY timestamp DESC
      LIMIT $offset, $rows
    ");
    
    while ($message = db_fetch_object($result)) {
      if ($message->new)
        $new = '<b>'.t("new").'</b>';
      else
        $new = '';
      $output .= "
        <tr>
          <td width='2%'><input type='checkbox' name='msg_to_del[]' value='$message->id'></td>
          <td width='3%'>$new</td>
          <td width='20%'>".format_date($message->timestamp, "small")."</td>
          <td width='30%'>".format_name($message)."</a></td>
          <td width='55%'><a href='module.php?mod=privatemsg&page=view&message_id=$message->id'>".check_output($message->subject)."</a></td>
        </tr>
      ";
    }
    
    if (!$output)
      $output = "<tr><td colspan=\"5\" align=\"center\">".t("No private messages")."</td></tr>";
    else
      $output = '
            <tr>
              <td width="2%"><b>'.t("del").'</b></td>
              <td width="3%">&nbsp;</td>
              <td width="20%"><b>'.t("date").'</b></td>
              <td width="30%"><b>'.t("from").'</b></td>
              <td width="55%"><b>'.t("subject").'</b></td>
            </tr>
            '.$output;
    return array("output" => $output, "num_rows" => db_num_rows($result));
  }
}


function _privatemsg_messages_sent($offset=0, $rows=10) {
  global $user;
  
  if ($user->uid) {
    $result = db_query("
      SELECT privatemsg.id, users.uid, name, privatemsg.timestamp, subject, new
      FROM privatemsg, users
      WHERE author = ".$user->uid." 
      AND recipient = users.uid
      ORDER BY timestamp DESC
      LIMIT $offset, $rows
    ");
    
    while ($message = db_fetch_object($result)) {
        if (($message->new) && (variable_get("privatemsg_sent_status", 1))) {
          $new = '<b>'.t("unread").'</b>';
          if (variable_get("privatemsg_del_unread", 1)) {
            $checkbox = "<input type='checkbox' name='msg_to_del[]' value='$message->id'>";
          } else {
            $checkbox = "&nbsp;";
          }
        } else {
          $new = "&nbsp;";
          $checkbox = "&nbsp;";
        }
      $output .= "
        <tr>
          <td width='2%'>$checkbox</td>
          <td width='3%'>$new</td>
          <td width='20%'>".format_date($message->timestamp, "small")."</td>
          <td width='30%'>".format_name($message)."</a></td>
          <td width='55%'><a href='module.php?mod=privatemsg&page=view&message_id=$message->id'>".check_output($message->subject)."</a></td>
        </tr>
      ";
    }
    
    if (!$output)
      $output = "<tr><td colspan=\"5\" align=\"center\">".t("No private messages sent")."</td></tr>";
    else
      $output = '
            <tr>
              <td width="2%"><b>'.((variable_get("privatemsg_del_unread", 1) && variable_get("privatemsg_sent_status", 1)) ? t("del") : "&nbsp;").'</B></td>
              <td width="3%">&nbsp;</td>
              <td width="20%"><b>'.t("date").'</b></td>
              <td width="30%"><b>'.t("to").'</b></td>
              <td width="55%"><b>'.t("subject").'</b></td>
            </tr>
            '.$output;
    return array("output" => $output, "num_rows" => db_num_rows($result));
  }
}


function _privatemsg_get_new_messages() {
  global $user;
  
  if ($user->uid) {
    $result = db_query("
        SELECT count(*)
        FROM privatemsg
        WHERE recipient = ".$user->uid."
        AND new = 1
      ");
    return db_result($result);
  } else {
    return 0;
  }
}


function _privatemsg_message_delete($message_id) {
  global $user;
  $sql = "
    SELECT id FROM privatemsg
    WHERE (recipient = ".$user->uid." OR (author = ".$user->uid." AND new = 1) )
    AND privatemsg.id = ".check_input($message_id);
    
  $result = db_query($sql);
  $message = db_fetch_object($result);
  if ($message) {    
    $sql = "
      DELETE FROM privatemsg
      WHERE id = ".check_input($message_id);
    
    $result = db_query($sql);
    return true;
  } else {
    return false;
  }
}


function _privatemsg_folder_label($label) {
  return "<tr><td colspan=\"5\" align=\"center\"><b><i>$label</i></b></td></tr>";
}


function _privatemsg_msg_navigator($in_offset, $out_offset, $rows) {
  return "<tr><td><a href=\"module.php?mod=privatemsg&in_offset=$in_offset&out_offset=$out_offset\">".t("Previous messages")."</a></td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td><a href=\"module.php?mod=privatemsg&in_offset=$in_offset&out_offset=$out_offset\">".t("Next messages")."</a></td></tr>";
}

?>